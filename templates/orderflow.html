<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="{{headLogo}}">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">

  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='main.css') }}">


</head>

<main role="main" class="container-md" style="background:black;height:100%;width:100%;position:absolute">

    <div id="vue-app" :class="getMargin()" style="background:black">


        <div class="text-white" align="center" >
            <br>

            <h1> Order Flow: [[ stream['lastPrice']  ]]</h1>

                <audio id="xyz" src="https://rekt-journal.s3.ap-northeast-1.amazonaws.com/alert.mp3" style="display:none" controls preload="auto"></audio>


            <button @click="showTable='Time'" type="button" class="btn btn-info" data-bs-toggle="button" autocomplete="off">Time</button>
            <button @click="showTable='Volume'" type="button" class="btn btn-warning" data-bs-toggle="button" autocomplete="off" aria-pressed="true">Volume</button>
            <button @click="showTable='Delta'" type="button" class="btn btn-success" data-bs-toggle="button" autocomplete="off">Delta</button>
            <button @click="showTable='Notes'" type="button" class="btn btn-secondary" data-bs-toggle="button" autocomplete="off">Notes</button>


            <br>
            <br>

        </div>

        <div align="center" :style="getFont()">

            <div v-if="showTable == 'Notes'" class="text-white p-3">

                <h3> Time Adjust </h3>

                    <input type="number" v-model="UTCadjust" style="width:20%">
                <br>
                <br>

                <h3> App Notes </h3>
                - Data presented is from current day <br>
                - Taken from Bybit API (BTCUSD.perp) <br>
                - Previous Day Data is also presented....<br>

                - Time mode is set to minimum 5 mins and goes up in increments of 5min <br>
                - Volume mode can be set to 1 (default), 2 and 5 mil blocks <br>
                - Volume blocks are exactly divisions of 1mil <br>
                (this is different from exocharts which carries over some trades so a 1mil block is actually more than 1mil) <br>
                Therefore, volume block data will differ from exocharts (developer's personal choice) <br>
                - Delta blocks are set to only record differences of 1mil delta (data does differ slightly from exo charts from time to time)<br>
                - In Delta and Volume mode you may view all trades greater than 1000 appearing in the current block <br>
                - An alert will occur on trades greater than 100K <br>

                <br>
                <br>

            </div>


            <div v-if="showTable == 'Time'" align="center">

                <div class="bg-info test-dark rounded p-1" >
                    <h3> <span @click="showStream = !showStream"> Time Blocks </span> <input style="width:10%" type="number" v-model="timeBlockSize" step="5"></h3>
                    <div v-if="showStream">
                        <span v-for="(info, key) in stream " :key="key"> [[key]]: [[info]] <br></span>
                    </div>
                </div>

            </div>

            <div v-if="showTable == 'Volume'">

                <div class="bg-warning test-dark rounded p-1"  >
                    <h3> <span @click="showBS = !showBS"> Volume Blocks </span> <input style="width:10%" type="number" v-model="volumeBlockSize" step="1"></h3>
                </div>

                <div v-if="showBS" class="row align-items-start m-2">
                    <div class="col-6" style="background:darkgreen;color:white">
                        <span> Buys: </span>  <span v-for="(item, key) in reverseTrades" :key="key" ><span v-if="item.side == 'Buy'"> [[item.size]] &nbsp &nbsp  </span></span>
                    </div>
                    <div class="col-6" style="background:firebrick;color:white">
                        <span> Sells: </span>  <span v-for="(item, key) in reverseTrades" :key="key" ><span v-if="item.side == 'Sell'"> [[item.size]] &nbsp &nbsp  </span></span>
                    </div>
                </div>

            </div>

            <div v-if="showTable == 'Delta'" align="center">

                <div class="bg-success test-dark rounded p-1"  >
                    <h3> <span @click="showBS = !showBS"> Delta Blocks </span></h3>
                </div>

                <div v-if="showBS" class="row align-items-start m-2">
                    <div class="col-6" style="background:darkgreen;color:white">
                        <span> Buys: </span>  <span v-for="(item, key) in reverseDelta" :key="key" ><span v-if="item.side == 'Buy'"> [[item.size]] &nbsp &nbsp </span></span>
                    </div>
                    <div class="col-6" style="background:firebrick;color:white">
                        <span> Sells: </span>  <span v-for="(item, key) in reverseDelta" :key="key" ><span v-if="item.side == 'Sell'"> [[item.size]] &nbsp &nbsp  </span></span>
                    </div>
                </div>

            </div>

            <div class="table-responsive">
                <table class="table table-dark table-sm">
                    <thead>
                    <tr>
                        <th scope="col" style="width:10%">Time</th>
                        <th scope="col">Sec</th>
                        <th scope="col">Vol</th>
                        <th scope="col" @click="hideDelta = !hideDelta">Delta</th>
                        <th scope="col">CVD</th>
                        <th scope="col">Buys</th>
                        <th scope="col">Sells</th>
                        <th scope="col">OI</th>
                        <th scope="col">Candle</th>
                        <th scope="col" style="width:2%">High</th>
                        <th scope="col" style="width:2%">Low</th>
                        <th scope="col" style="width:2%">Close</th>
                    </tr>
                    </thead>
                    <tbody v-if="showTable == 'Volume'">
                        <template v-for="(item, key) in getReverseVolumeBlocks" :key="key" >
                        <tr>
                            <th class="text-warning text-xsmall" scope="row"><span @click="showVolCandle = key">[[getTime(item.timestamp)]]</span> </th>
                            <td>[[calculateTime(item.time_delta)]]</td>
                            <td style="display:none">[[item]]</td>
                            <td>[[roundData(item.total)]]</td>
                            <td :style="getDeltaStyle(item.delta)">[[getPercent(item.delta, item.total)]]%</td>
                            <td :style="getCVDStyle(item.divergence, key, item.delta_cumulative, 'vol')">[[item.delta_cumulative]]</td>
                            <td :style="getDeltaStyle(1)">[[roundData(item.buys)]]</td>
                            <td :style="getDeltaStyle(-1)">[[roundData(item.sells)]]</td>
                            <td style="display:none">[[item.oi_cumulative]]</td>
                            <td :style="getOIStyle(item.oi_delta)">[[roundData(item.oi_delta)]]</td>
                            <td :style="getCandleStyle(item.open, item.close)">[[item.price_delta]] <span v-if="!mobile">/ ([[Math.abs(item.high - item.low)]]) </span></td>
                            <td>[[item.high]]</td>
                            <td>[[item.low]]</td>
                            <td >[[item.close]]</td>
                        </tr>
                                <template v-if="showVolCandle == key">
                                    <tr >
                                        <span @click="showVolCandle = null"> [[ item ]]  </span>
                                    </tr>
                                </template>
                        </template>
                    </tbody>
                    <tbody v-if="showTable == 'Time'">
                        <template v-for="(item, key) in getReverseTimeBlocks" :key="key" >
                          <tr v-if="key < timeBlockList">
                            <th class="text-info" scope="row"><span @click="showCandle = key">[[getTime(item.timestamp)]]</span> </th>
                            <td>[[calculateTime(item.time_delta)]]</td>
                            <td style="display:none">[[item.vol_cumulative]]</td>
                            <td :style="getVolumeStyle(item.pva_status, key)">[[roundData(item.total)]]</td>
                            <td :style="getDeltaStyle(item.delta)"><span v-if="!mobile && !hideDelta">[[roundData(item.delta)]] &nbsp &nbsp </span> [[getPercent(item.delta, item.total)]]%</td>
                            <td :style="getCVDStyle(item.divergence, key, item.delta_cumulative, 'time')">[[item.delta_cumulative]]</td>
                            <td :style="getDeltaStyle(1)">[[roundData(item.buys)]]</td>
                            <td :style="getDeltaStyle(-1)">[[roundData(item.sells)]]</td>
                            <td style="display:none">[[item.oi_cumulative]]</td>
                            <td :style="getOIStyle(item.oi_delta)">[[roundData(item.oi_delta)]]</td>
                            <td :style="getCandleStyle(item.open, item.close)">[[item.price_delta]] <span v-if="!mobile"> / ([[Math.abs(item.high - item.low)]]) </span></td>
                            <td :style="getLocal('high', key)">[[item.high]]</td>
                            <td :style="getLocal('low', key)">[[item.low]]</td>
                            <td >[[item.close]]</td>
                          </tr>
                                <template v-if="showCandle == key">
                                    <tr>
                                        <span @click="showCandle = null">
                                            PVA% : [[Math.round(item.pva_status.percentage * 100)]] <br>
                                            <br>
                                            HIGH: [[item.divergence.highInfo]]<br>
                                            LOW: [[item.divergence.lowInfo]]<br>
                                            <br>
                                            [[item.pva_status]]<br>

                                        </span>
                                    </tr>

                                </template>

                        </template>
                    </tbody>
                    <tbody v-if="showTable == 'Delta'">
                        <template v-for="(item, key) in getReverseDeltaBlocks" :key="key" >
                        <tr>
                            <th class="text-success" scope="row"><span @click="showCandle = key">[[getTime(item.timestamp)]]</span> </th>
                            <td>[[calculateTime(item.time_delta)]]</td>
                            <td style="display:none">[[item.vol_cumulative]]</td>
                            <td :style="getVolumeStyle(item.pva_status, key)">[[roundData(item.total)]]</td>
                            <td :style="getDeltaStyle(item.delta)"> [[roundData(item.delta)]]<span v-if="!mobile">  &nbsp &nbsp [[getPercent(item.delta, item.total)]]%</span> </td>
                            <td :style="getCVDStyle(item.divergence, key, item.delta_cumulative, 'delta')">[[item.delta_cumulative]]</td>
                            <td :style="getDeltaStyle(1)">[[roundData(item.buys)]]</td>
                            <td :style="getDeltaStyle(-1)">[[roundData(item.sells)]]</td>
                            <td style="display:none">[[item.oi_cumulative]]</td>
                            <td :style="getOIStyle(item.oi_delta)">[[roundData(item.oi_delta)]]</td>
                            <td :style="getCandleStyle(item.open, item.close)">[[item.price_delta]] <span v-if="!mobile"> / ([[Math.abs(item.high - item.low)]]) </span></td>
                            <td >[[item.high]]</td>
                            <td >[[item.low]]</td>
                            <td >[[item.close]]</td>
                        </tr>
                                <template v-if="showCandle == key">
                                    <tr>
                                        <span @click="showCandle = null">
                                            [[item]]
                                        </span>
                                    </tr>

                                </template>

                        </template>
                    </tbody>

                </table>
            </div>
        </div>



    </div> <!-- end vue app-->

</main>

{% block script %}
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>


<script type="text/javascript">


var report = navigator.userAgent
console.log(report)

let mobile = false

if (report.includes('Android') || report.includes('iPhone') ) {
    mobile = true
    console.log('mobile')
}

startVue()


function startVue(){

let vue = new Vue({

    el: '#vue-app',
    delimiters: ['[[', ']]'],
    mounted: function() {
        this.ofTimer()
        this.getOFData()
        if (mobile) {
            this.showBS = false
            this.mobile = true
        }
    },
    data: {
        showStream: false,
        showBS: true,
        showTable: 'Time',
        UTCadjust: 8,
        hideDelta: true,
        showCandle: null,
        showVolCandle: null,
        mobile: false,
        volumeBlocks : [],
        volumeFlow : [],
        timeBlocks : [],
        timeFlow : [],
        deltaBlocks : [],
        deltaFlow : [],
        stream : {},
        volumeBlockList: 20,
        volumeBlockSize: 1,
        timeBlockList: 100,
        timeBlockSize: 5,
        of_timer : '',
        ofAlert : 0,
        localHigh : 0,
        localLow : 0
    },
    methods: {
        getLocal: function (mode, key) {
            let sets = {
                    high : this.localHigh,
                    low : this.localLow,
                }
            let colors = {
                    high : 'lightgreen',
                    low : 'crimson',
                }

            if (this.timeBlockSize == 5) {
                if (key == sets[mode] + 1) {
                return { background: 'grey' , color: colors[mode]}
                }
            }
        },
        getCVDStyle: function (CVDdivergence, key, CVD, mode) {
            if (key == 1 && CVDdivergence && mode == 'time') {

                this.localLow = CVDdivergence.lowInfo.index
                this.localHigh = CVDdivergence.highInfo.index
                // console.log(this.localHigh , CVDdivergence.highInfo, this.localLow, CVDdivergence.lowInfo, CVD)
            }

            if (this.timeBlockSize == 5 && mode == 'time' && key != 0) {
                if (CVDdivergence && CVDdivergence.highInfo.div) {
                    return {color: 'pink'}
                } else if (CVDdivergence && CVDdivergence.lowInfo.div) {
                    return {color: 'lightblue'}
                }
            }

            let candles = {
                time : this.getReverseTimeBlocks[key + 1 ],
                vol : this.getReverseTimeBlocks[key + 1 ],
                delta : this.getReverseTimeBlocks[key + 1 ]
            }

            previousCandle = candles[mode]

            if (previousCandle && CVD < previousCandle['delta_cumulative']) {
                return {color: 'red'}
            } else if (previousCandle && CVD > previousCandle['delta_cumulative']) {
                return {color: 'lightgreen'}
            }

        },
        getMargin: function () {
            if (this.mobile) {
                return "content-section"
            } else {
                return "content-section ml-5 mr-5"
            }
        },
        getFont: function () {
            if (this.mobile) {
                return "font-size:12px"
            }
        },
        getTime: function (t) {
            let time = t.split(' ')
            let adjust = this.UTCadjust
            if (!parseInt(adjust)) {
                adjust = 0
            }
            let hours = parseInt(time[1].split(':')[0]) + parseInt(adjust)
            if (hours > 23) {
                hours = hours - 24
            }
            let newTime = time[1].split(':')
            let x = time[0] + ' '

            if (this.mobile) {
                return hours + ':' + newTime[1]
            } else {
                return time[1] + ' (' + hours + ')'
            }

        },
        roundData: function (data) {
            //deal with K
            if (data >= 1000000 || data <= -1000000) {
                let x = data/100000
                let y = Math.round(x)
                let r = y.toString()/10
                return r + 'm'
            } else {
                let x = data/1000
                let y = Math.round(x)
                let r = y.toString()
                return r + 'K'
            }

        },
        getPercent: function (data, total) {
            //deal with K
            let x = (data/total)*100
            let y = Math.round(x)
            let r = y.toString()
            return r
        },
        calculateTime: function (ms) {
            return Math.round((ms/1000))
        },
        getCandleStyle: function(open, close) {
            let style = {background : 'firebrick'}
            if (open < close) {
                style = {background : 'darkgreen'}
            }
            return style
        },
        getOIStyle: function(oi) {
            let style = {background : 'blue', color : 'white'}
            if (oi == 0) {
                style = {}
            } else if (oi < -1000000) {
                style = {background : 'DarkSlateBlue', color : 'white'}
            }else if (oi < 0) {
                style = {background : 'purple', color : 'white'}
            }else if (oi > 1000000) {
                style = {background : 'DodgerBlue', color : 'white'}
            }
            return style
        },
        getDeltaStyle: function(delta, ) {
            let style = {background : 'darkcyan'}
            if (delta < 0) {
                style = {background : 'OrangeRed'}
            }
            return style
        },
        getVolumeStyle: function(pva_status, key) {

            let style = {}

            if (this.timeBlockSize != 5) {
                return style
            }

            if (pva_status['pva150']) {
                style = {background : 'grey'}
            } else if (pva_status['pva200']) {
                style = {background : 'cadetblue'}
            }
            if (pva_status['pva200'] && pva_status['PVAbearDIV']) {
                style['color'] = 'red'
            } else if (pva_status['pva200'] && pva_status['PVAbullDIV']) {
                style['color'] = 'green'
            }

            return style
        },
        ofTimer: function () {
            this.of_timer = setInterval(this.getOFData, 3000)
            console.log('timer', this.of_timer)
        },
        clearOF: function () {
            clearInterval(this.of_timer)
        },
        clearLimitPrice: function () {
            this.limitData.price = 0
        },
        getCurrentDelta: function () {
            let dDict = {
                'Buy' : 0,
                'Sell' : 0,
                'Delta' : 0,
                'Total' : 0,
            }

            for(let t in this.volumeFlow) {
                trade = this.volumeFlow[t]

                dDict[trade['side']] += trade['size']
                dDict['Total'] += trade['size']

            }

            dDict['Delta'] = dDict['Buy'] - dDict['Sell']

            return dDict
        },
        getOFData: function (mode) {
            console.log('getOFData')

            $.ajax({
                data : {
                    volumeBlockSize: this.volumeBlockSize,
                    timeBlockSize: this.timeBlockSize
                },
                type : 'POST',
                url : '/getOF'

            })
            .done(function(data) {
                console.log('OF data received')
                vue.volumeFlow = JSON.parse(data.volumeFlow)

                vue.volumeBlocks = JSON.parse(data.volumeBlocks)

                vue.stream = JSON.parse(data.stream)

                vue.timeBlocks = JSON.parse(data.timeBlocks)

                vue.timeFlow = JSON.parse(data.timeFlow)

                vue.deltaBlocks = JSON.parse(data.deltaBlocks)

                vue.deltaFlow = JSON.parse(data.deltaFlow)

            })
            .fail(function(){
                  alert('error has occurred gData');
            });
        },
        start: function (mode) {
            console.log('start')

            $.ajax({
                data : {
                    volumeBlockSize: this.volumeBlockSize,
                },
                type : 'POST',
                url : '/startOF'

            })
            .done(function(data) {
                console.log(data)
            })
            .fail(function(){
                  alert('error has occurred gData');
            });
        },


    },
    computed: {
        reverseTrades() {
            let newList = []
            let newList2 = []
            let flow = this.volumeFlow

            for (let x in flow) {
                let s = flow[x]['size']
                if (s > 1000) {
                    let ns = Math.round(s/100)/10
                    if (s >= 100000) {
                       flow[x]['size'] = '!!' + ns + 'k !!'
                       newList2.push(flow[x])
                    } else if ( s >= 10000) {
                        flow[x]['size'] = ns + 'k'
                        newList2.push(flow[x])
                    } else {
                        newList.push(flow[x])
                    }
                }
            }
            let finalList = newList.concat(newList2)
            return finalList
        },
        reverseDelta() {
            let newList = []
            let newList2 = []
            let flow = this.deltaFlow

            for (let x in flow) {
                let s = flow[x]['size']
                if (s > 1000) {
                    let ns = Math.round(s/100)/10
                    if (s >= 100000) {
                       flow[x]['size'] = '!!' + ns + 'k !!'
                       newList2.push(flow[x])
                    } else if ( s >= 10000) {
                        flow[x]['size'] = ns + 'k'
                        newList2.push(flow[x])
                    } else {
                        newList.push(flow[x])
                    }
                }
            }
            let finalList = newList.concat(newList2)
            return finalList
        },
        getReverseVolumeBlocks() {
            return this.volumeBlocks.slice().reverse()
        },
        getReverseDeltaBlocks() {
            return this.deltaBlocks.slice().reverse()
        },
        getReverseTimeBlocks() {
            return this.timeBlocks.slice().reverse()
        },
    },
    watch: {
        volumeBlockSize: function () {
            if (this.volumeBlockSize == 3 || this.volumeBlockSize > 5) {
                this.volumeBlockSize = 5
            } else if (this.volumeBlockSize == 4) {
                this.volumeBlockSize = 2
            } else if (this.volumeBlockSize <= 0) {
                this.volumeBlockSize = 1
            }
        },
        ofAlert: function () {
            if(this.ofAlert < -800){
                if (this.audioToggle) {
                    document.getElementById('xyz').play();
                }
                //alert("Thank you!");
            }
        }
    }

})// end NEW VUE

}


</script>



{% endblock %}



